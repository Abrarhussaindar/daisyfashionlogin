<!DOCTYPE html>
<html lang="en">
  <head>
    {% load static %}
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Home</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}" />
    <style>
      #counter-div {
        position: fixed;
        bottom: 20px;
        left: 20px;
        background-color: #f1f1f1;
        padding: 10px;
        border-radius: 5px;
      }
      * {
        margin: 0;
        padding: 0;
      }
      
      body {
        background-color: #f5f5f5;
      }
      body header {
        padding: 20px;
        font-size: 20px;
        font-weight: 600;
        color: white;
        background-color: rgb(151, 151, 151);
        border-radius: 5px;
      }
      body header .header-btns {
        display: flex;
        justify-content: space-between;
      }
      body header .header-btns .lg-btn a {
        padding: 10px 30px;
        border-radius: 5px;
        background-color: #881769;
        text-decoration: none;
        color: white;
      }
      body main {
        background-color: white;
        box-shadow: rgba(0, 0, 0, 0.5) 0px 3px 8px;
        max-width: 1140px;
        margin: auto;
        border-radius: 0 0 20px 20px;
      }
      body main .personal_info {
        display: flex;
        justify-content: space-between;
        padding: 20px;
      }
      body main .personal_info .lg_details .info {
        padding: 10px;
        color: #881769;
      }
      body main .personal_info .lg_details table {
        text-align: center;
        padding: 5px;
        background-color: white;
      }
      body main .personal_info .lg_details table tr th, body main .personal_info .lg_details table tr td {
        padding: 10px;
      }
      body main .personal_info .canv {
        display: flex;
      }
      body main .personal_info .canv .kuch-bhi {
        width: 150px;
        height: 150px;
      }
      body main .personal_info .canv .kuch-bhi .wd {
        display: flex;
        justify-content: center;
        margin-top: 10px;
        font-weight: bold;
      }
      body main .personal_info .canv .tw {
        margin: 40px 0 0 25px;
      }
      body main .personal_info .canv .tw table {
        text-align: center;
        padding: 5px;
      }
      body main .personal_info .canv .tw table tr th, body main .personal_info .canv .tw table tr td {
        padding: 10px;
      }
      body main .personal_info .canv .tw .twt {
        color: green;
        font-size: 18px;
      }
      body main .personal_info .canv .tw .trt {
        color: red;
        font-size: 18px;
      }
      body main .emp-table {
        padding: 20px;
      }
      body main .emp-table .info {
        padding: 10px;
        color: #881769;
        font-weight: 900 !important;
      }
      body main .emp-table table {
        text-align: center;
        width: 100%;
      }
      body main .emp-table table tr th {
        width: 14%;
      }
      body main .emp-table table tr th, body main .emp-table table tr td {
        padding: 10px;
      }
      body main .emp-table table tr .twd {
        color: green;
      }
      body main .emp-table table tr .tr {
        color: red;
      }
      body main .emp-table table tr td .twd, body main .emp-table table tr td .tr {
        font-weight: 900;
      }
      body .wrapper-visibility,
      body .category-visibilty {
        display: none !important;
      }
      body .container .category {
        display: block;
      }
      body .container .category .category-btns {
        margin: 10px;
        border: 1px solid black;
        background-color: rgb(151, 151, 151);
        color: white;
        padding: 15px 30px;
        font-size: 18px;
        text-decoration: none;
        border-radius: 5px;
        cursor: pointer;
      }
      body .wrapper {
        margin: 150px auto;
        max-width: 500px;
        height: 400px;
        background: #f5f5f5;
        border: solid 1px #ccc;
        border-radius: 5px;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: center;
      }
      body .wrapper form .field {
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 15px;
        padding-bottom: 20px;
        border-bottom: 1px solid #ccc;
      }
      body .wrapper form .field label {
        width: 50%;
        font-size: 20px;
        color: black;
      }
      body .wrapper form .field input {
        width: 50%;
        font-size: 16px;
        color: black;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
      }
      body .wrapper form .submit-btn {
        width: 50%;
        font-size: 18px;
        color: black;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        cursor: pointer;
        margin: 20px 50px 20px 100px;
      }
      body footer .sticky-fixed-popup {
        position: fixed;
        bottom: 2%;
        left: 1%;
        width: -moz-max-content;
        width: max-content;
        padding: 20px;
        font-size: 20px;
        font-weight: 600;
        color: white;
        background-color: rgb(151, 151, 151);
        border-radius: 5px;
      }/*# sourceMappingURL=style.css.map */
    </style>
  </head>
  <body>
    <header>
      <div class="header-btns">
        <div class="emp">
          {% if user.is_authenticated %}Welcome! "{{ emp.name }}" {% endif %}
        </div>
        <div class="lg-btn">
          {% if user.is_authenticated %}
          <a id="logout-link" href="{% url 'user_logout' %}">Log Out</a>
          {% if user.is_teamLead %}
          <a id="logout-link" href="{% url 'permissions' %}"
            >Change Permissions</a
          >
          {% endif %} {% else %}
          <a href="{% url 'login' %}">Log in</a>
          <a href="{% url 'register' %}">Sign Up</a>
          {% endif %}
        </div>
      </div>
    </header>

    <main>
      {% if user.is_authenticated %}
      <div class="personal_info">
        <div class="lg_details">
          <div class="info">
            <h2>Personal Login Details:</h2>
          </div>
          <table>
            <tr>
              <th>In Time</th>
              <th>Previous Logout Time</th>
              <th>Last Login Duration</th>
            </tr>

            <tr>
              <td>{{ emp.intime }}</td>
              <td>{{ emp.out_time }}</td>
              <td>{{ emp.duration_time }}</td>
            </tr>
          </table>
        </div>

        <div class="canv">
          <div class="tw">
            <table>
              <tr>
                <th class="twt">Total Work Time</th>
                <th class="trt">Total Remaining Time</th>
              </tr>
              <tr>
                <td class="twt" style="font-weight: 900">
                  <span id="total-work">{{ total_work }}</span>
                </td>
                <td class="trt" style="font-weight: 900">
                  <span id="remaining-time">{{ remaining_time }}</span>
                </td>
              </tr>
            </table>
          </div>
          <div class="kuch-bhi">
            <canvas
              id="workChart"
              width="50"
              height="50"
              style="
                display: block;
                box-sizing: border-box;
                height: 50px;
                width: 50px;
              "
            ></canvas>
            <div class="wd">Work Done</div>
          </div>
        </div>
      </div>
      {% endif %} {% if user.is_teamLead %}
      <div class="emp-table">
        <div class="info">
          <h2>Other Employee's Login Details:</h2>
        </div>
        <table>
          <tr>
            <th>Name</th>
            <th class="twd">Total Work Done</th>
            <th class="tr">Time Remaining</th>
            <th>In Time</th>
            <th>Previous Logout Time</th>
            <th>Last Login Duration</th>
            <th>Permission</th>
          </tr>
          {% for emp in employees %}
          <tr>
            <td>{{ emp.name }}</td>
            <td class="twd" style="font-weight: 900">{{ emp.work_time }}</td>
            <td class="tr" style="font-weight: 900">
              {{ emp.remaining_time }}
            </td>
            <td>{{ emp.intime }}</td>
            <td>{{ emp.out_time }}</td>
            <td>{{ emp.duration_time }}</td>
            <td>{{ emp.permission }}</td> 
          </tr>
          {% endfor %}
        </table>
      </div>
      {% endif %}
    </main>


    <footer></footer>


    <script>
      var inactivityTimeout = 10000; // Inactivity timeout in seconds (e.g., 300 seconds = 5 minutes)
      var inactivityTimer;

      function resetInactivityTimer() {
        clearTimeout(inactivityTimer);
        inactivityTimer = setTimeout(logoutUser, inactivityTimeout * 1000);
      }

      function logoutUser() {
        var currentUserDepartment = "{{ emp.department }}"; // Replace with the variable that holds the employee's department
        var excludedDepartments = ["Sales"]; // Add the department names to exclude from the inactivity timer

        // Check if the current user's department is in the excluded departments list
        if (!excludedDepartments.includes(currentUserDepartment)) {
          sessionStorage.removeItem("startTime");
          window.location.href = "{% url 'user_logout' %}";
        }
      }

      document.addEventListener("mousemove", resetInactivityTimer);
      document.addEventListener("keydown", resetInactivityTimer);
      resetInactivityTimer();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      // Get the canvas element
      var workChartCanvas = document.getElementById('workChart');

      // Create the chart context
      var ctx = workChartCanvas.getContext('2d');

      // Initialize the chart
      var chart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          datasets: [
            {
              data: [0, 8 * 3600], // Initial data (0 hours worked)
              backgroundColor: [
                'red', // Color for remaining work time
                'green', // Color for worked time
              ],
            },
          ],
        },
        options: {
          cutoutPercentage: 70, // Set the size of the inner circle
          tooltips: {
            enabled: false, // Disable tooltips
          },
        },
      });

      // Update the chart data with the employee's work time
      var workTime = {{ total_work_seconds }};
      var remainingTime = Math.max(8 * 3600 - workTime, 0);
      chart.data.datasets[0].data = [remainingTime, workTime];
      chart.update();
    </script>

    <script>
      function updateData() {
        // Make an AJAX request to the server to get the updated work time and remaining time
        fetch("{% url 'get_work_time' %}")
          .then((response) => response.json())
          .then((data) => {
            // Update the total work time
            document.getElementById("total-work").innerText = data.work_time;

            // Update the remaining time (assuming you receive it in 'remaining_time' field)
            document.getElementById("remaining-time").innerText =
              data.remaining_time;
          })
          .catch((error) => {
            console.error("Error updating data:", error);
          });
      }

      // Refresh data every 10 seconds
      setInterval(updateData, 1000);

      // Run the initial update when the page loads
      updateData();
    </script>
    {% comment %} <script>
      // Function to perform logout when the window is closed or navigated away
      function logoutOnWindowClose() {
        // Make an AJAX request to the server to log out the user
        var xhr = new XMLHttpRequest();
        xhr.open("GET", "{% url 'user_logout' %}", true);
        xhr.send();
      }

      // Attach the 'beforeunload' event to the window
      window.addEventListener('beforeunload', logoutOnWindowClose);
    </script> {% endcomment %}
  </body>
</html>
